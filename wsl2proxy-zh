#!/bin/bash

##########################################
# Copyrights 2020, Wizcas <chen@0x1c.dev>
#
# This script is under MIT license
##########################################

#----------- è¾…åŠ©å·¥å…· -----------
####### é¢œè‰²ç  ########
RED="\033[31m"     # Error message
GREEN="\033[32m"   # Success message
YELLOW="\033[33m"  # Warning message
BLUE="\033[34m"    # Info message
MAGENTA="\033[35m" # Info message
TEAL="\033[36m"    # Info message
RAW="\033[0m"

colorEcho() {
  echo -e "${1}${@:2}${RAW}" 1>&2
}
##########################

# ä¸€äº›é¢„å®šä¹‰å¸¸é‡
VERSION='0.2.0'
conf="${HOME}/.wsl2proxy.conf"
socks="${HOME}/socksproxy"
varsfile="${HOME}/wsl2proxy.vars"
cmd="wsl2proxy"

# ä»WSLçš„DNSé…ç½®ä¸­è§£æå½“å‰Windowsä¸»æœºçš„è®¿é—®IPï¼Œå› ä¸ºæ¯æ¬¡é‡å¯éƒ½ä¼šå˜
host=$(cat /etc/resolv.conf | sed -n 's/^nameserver\W\(.*\)$/\1/p')

# è®©ç”¨æˆ·é€‰æ‹©ä»£ç†ç”¨ä»€ä¹ˆåè®®
selectProtocol() {
  echo -e "\n${YELLOW}[STEP 1]${BLUE} ä»£ç†åè®®: ${RAW}\n---- è¯·é€‰æ‹©æ•°å­— ----"
  PROTOCOLS=("http" "https" "socks5" "socks4")
  PS3="-----------------
Protocol > "
  select protocol in ${PROTOCOLS[@]}; do
    case $protocol in
    "http" | "https")
      ncProtocol="connect"
      break
      ;;
    "socks5")
      ncProtocol=5
      break
      ;;
    "socks4")
      ncProtocol=4
      break
      ;;
    *)
      colorEcho ${RED} "è¯·é€‰æ‹©ä¸€ä¸ªä»1åˆ°${#PROTOCOLS[@]}çš„æ•°å­—"
      ;;
    esac
  done
}

# Let user input the proxy server port
inputPort() {
  echo -e "\n${YELLOW}[STEP 2]${BLUE} ä»£ç†ç«¯å£: ${RAW}"
  while true; do
    read -p "Port > " port
    if [ -z ${port} ]; then
      colorEcho ${RED} "ä½ çš„ä»£ç†æ€»å¾—æœ‰ä¸ªç«¯å£å§ï¼ŸğŸ˜’"
    else
      if [[ ${port} =~ ^[1-9][0-9]+$ ]] && [[ ${port} -le 65535 ]]; then
        break
      else
        colorEcho ${RED} "æ— æ•ˆçš„ç«¯å£å·"
      fi
    fi
  done
}

# Save configs into a conf file
saveConf() {
  echo "# This file is for storaging WSL proxy settings.
# The host IP is not recorded since it changes every time on reboot.

protocol=${protocol}
ncProtocol=${ncProtocol}
port=${port}
  " >${conf}

  colorEcho ${GREEN} "
ä»£ç†é…ç½®å·²æˆåŠŸå­˜å‚¨åˆ° ${YELLOW}${conf}${GREEN}, è¯·ä¸è¦åˆ é™¤ã€‚
"
}

# Since SSH proxy depends on `nc` tool for forwarding,
# this function checks the prerequisite
checkNc() {
  command -v nc >/dev/null
  nc=$?
  if [ $nc -ne 0 ]; then
    colorEcho ${RED} "è­¦å‘Š: æœªæ‰¾åˆ°å‘½ä»¤${YELLOW}nc${RED}ã€‚SSHä»£ç†éœ€è¦ä½¿ç”¨è¯¥å‘½ä»¤ï¼Œè¯·è‡ªè¡Œå®‰è£…ã€‚"
  fi
}

# Create a utility for calling nc to forward network traffics
setupSocksProxy() {
  updateSocksProxy

  echo -e "\
-------------
${RED}[éœ€è¦æ‰‹åŠ¨è®¾ç½®]${RAW}

å·²åˆ›å»ºç½‘ç»œè¯·æ±‚è½¬å‘è„šæœ¬${YELLOW}${socks}${RAW}ï¼Œ
è¯·è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼Œä»¥ä¾¿æ­£å¸¸ä½¿ç”¨SSHä»£ç†ä¸gité€šä¿¡ï¼š

1) æ–°å»ºæˆ–ç¼–è¾‘æ–‡ä»¶${YELLOW}~/.ssh/config\e${RAW}ï¼Œå¹¶å†™å…¥ç±»ä¼¼ä¸‹é¢çš„å†…å®¹ï¼š
   (ä½ å¯èƒ½éœ€è¦é¦–å…ˆç»™è¯¥æ–‡ä»¶å¯å†™æƒé™)
${TEAL}
Host github.com
    User git
    ProxyCommand ${socks} '%h %p'
${RAW}
2) é‡æ–°ç»™${YELLOW}~/.ssh/config${RAW}æ–‡ä»¶ä¸€ä¸ªåªè¯»æƒé™ï¼Œä»¥é€šè¿‡SSHå®‰å…¨æ£€æŸ¥
${TEAL}
chmod 400 ~/.ssh/config
${RAW}
-------------"
}

updateSocksProxy() {
  # Makes the proxy command
  echo "#!/bin/bash
nc -x ${host}:${port} -X ${ncProtocol} \$*
" >${socks}
  chmod +x ${socks}
}

# The `setup` command's handler
setup() {
  selectProtocol
  inputPort
  echo -e "ä½ çš„ä»£ç†æœåŠ¡å™¨æ˜¯: ${TEAL}${protocol}://${host}:${port}${RAW}"
  echo
  while true; do
    read -p "åœ°å€æ˜¯å¦æ­£ç¡®? (Y/n): " CONFIRMED
    case $CONFIRMED in
    "y" | "Y" | "")
      break
      ;;
    "n" | "N")
      colorEcho ${BLUE} "ğŸ‘‹ğŸ»ï¸ å†è§"
      exit 2
      ;;
    *)
      colorEcho ${RED} "å•¥ï¼Ÿ"
      ;;
    esac
  done

  saveConf
  checkNc
  setupSocksProxy

  colorEcho ${RED} "<<< éšWSLå¯åŠ¨è‡ªåŠ¨å¼€å¯ä»£ç† >>>"
  echo -e "${TEAL}æ³¨æ„: ${RAW}æœ¬å·¥å…·çš„ä»£ç†è®¾ç½®ä¼šåº”ç”¨åˆ°
${YELLOW}http_proxy, https_proxy${RAW}å’Œ${YELLOW}.gitconfig${RAW}ä¸Š

è‹¥éœ€éšWSLå¯åŠ¨è‡ªåŠ¨å¼€å¯ä»£ç†ï¼Œè¯·å°†ä¸‹é¢è¿™è¡Œä»£ç æ·»åŠ åˆ°${YELLOW}$(getProfile)${RAW}ä¸­
(æ³¨æ„ä¸è¦é—æ¼å‘½ä»¤å¼€å¤´çš„â€˜.â€™)ï¼š

    ${TEAL}. ${cmd} on${RAW}
"
}

# Load proxy settings from our config file. Throws an error message if not found.
loadConf() {
  if [ ! -f "${conf}" ]; then
    colorEcho ${RED} "
æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶${TEAL}${conf}${RED}ï¼Œè¯·é¦–å…ˆæ‰§è¡Œ${YELLOW}setup${RED}å‘½ä»¤ã€‚
  
${RAW}ç”¨æ³•:    ${cmd} setup"
    exit 1
  fi
  . "${conf}"
  url="${protocol}://${host}:${port}"
}

# Determine what's the shell's profile script
getProfile() {
  if [ -n "$($SHELL -c 'echo $ZSH_VERSION')" ]; then
    # assume Zsh
    echo '.zshrc'
  elif [ -n "$($SHELL -c 'echo $BASH_VERSION')" ]; then
    # assume Bash
    echo '.bashrc'
  else
    # assume something else
    echo "shellå¯åŠ¨è„šæœ¬"
  fi
}

# The `on` command's handler
on() {
  loadConf
  echo -e "æ­£åœ¨é…ç½®ä»£ç†æœåŠ¡å™¨ ${YELLOW}${url}${RAW}"
  export http_proxy=${url}
  export https_proxy=${url}
  applyGit ${url}
  updateSocksProxy
}

# Set the proxy settings for git
applyGit() {
  # For HTTP/HTTPS protocol
  git config --global http.proxy $1
  git config --global https.proxy $1
  # For git:// protocol
  git config --global core.gitproxy ${socks}
  echo "âœ”ï¸ï¸ gitè®¾ç½®å®Œæ¯•"
}

# Unset all proxy settings
off() {
  unset http_proxy
  unset https_proxy
  echo "ğŸ‘‹ğŸ»ï¸ å·²åˆ é™¤ç³»ç»Ÿå˜é‡"
  git config --global --unset http.proxy
  git config --global --unset https.proxy
  git config --global --unset core.gitproxy
  echo "ğŸ‘‹ğŸ»ï¸ å·²åˆ é™¤gité…ç½®"
  colorEcho ${RED} "
å¦‚æœä¸å†ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼Œåˆ«å¿˜äº†:
${RAW}
1.  åˆ é™¤æˆ–æ³¨é‡Šæ‰${YELLOW}$(getProfile)${RAW}ä¸­ wsl2proxy ç›¸å…³çš„éƒ¨åˆ†
2.  åˆ é™¤æˆ–æ³¨é‡Šæ‰${YELLOW}~/.ssh/config${RAW}ä¸­çš„ä»£ç†è®¾ç½®
"
}

# Print the help info
help() {
  echo -e "
WSLä»£ç†æœåŠ¡å™¨é…ç½®å·¥å…·

    - authored by Wizcas <chen@0x1c.dev>

æœ¬å·¥å…·è‡ªåŠ¨æ£€æµ‹WSLçš„Windowsä¸»æœºåœ°å€ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰çš„ä»£ç†ä¿¡æ¯ä¸º
HTTPï¼ŒHTTPSå’ŒGitæ·»åŠ ä»£ç†é…ç½®ã€‚

Usage:
  ${cmd} <COMMAND>

Commands:
  install  å°†è„šæœ¬å®‰è£…åˆ° /usr/local/bin
  setup    è®¾ç½®ä»£ç†å‚æ•° (åè®®ã€ç«¯å£ç­‰) ï¼Œå¹¶åˆ›å»ºsocksä»£ç†
           è½¬å‘è„šæœ¬
  on       å¼€å¯ä»£ç†è®¾ç½®ï¼Œåªæœ‰ä½¿ç”¨setupæ­£å¸¸é…ç½®åæ‰èƒ½ç”Ÿæ•ˆã€‚
           æ‰§è¡Œæ–¹å¼ï¼š${TEAL}. ${cmd} on${RAW}
  off      å…³é—­ä»£ç†è®¾ç½®ã€‚
           æ‰§è¡Œæ–¹å¼ï¼š${TEAL}. ${cmd} off${RAW}
  url      æ‰“å°å½“å‰çš„ä»£ç†æœåŠ¡å™¨åœ°å€
  help     æ˜¾ç¤ºæœ¬å¸®åŠ©ä¿¡æ¯
  version  æ˜¾ç¤ºè„šæœ¬ç‰ˆæœ¬
"
}

# installs the script to /usr/local/bin
install() {
  if [ "$EUID" -ne 0 ]; then
    colorEcho ${RED} "
è¯·ä½¿ç”¨rootæƒé™æ‰§è¡Œè„šæœ¬ï¼Œå¦‚ï¼š

    ${RAW}sudo $0 install
"
    exit 1
  fi
  exePath="/usr/local/bin/${cmd}"
  cp -f $(realpath $0) ${exePath}
  chmod +x ${exePath}
  echo "âœ”ï¸ï¸ å®‰è£…å®Œæˆã€‚ç°åœ¨å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤é…ç½®ä»£ç†:

    ${cmd} setup
  "
}

# Main entry of the bash script
case $1 in
install)
  install
  ;;
setup)
  setup
  ;;
off)
  off
  ;;
on)
  on
  ;;
url)
  loadConf
  echo ${url}
  ;;
version)
  echo WSL2Proxy: ${VERSION}
  ;;
*)
  help
  ;;
esac
